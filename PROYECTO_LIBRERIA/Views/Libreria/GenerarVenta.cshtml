@{
    ViewData["Title"] = "Generar Venta";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* --- ESTILOS VISUALES (Del segundo código) --- */
    .card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .card-header {
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .shadow-sm-custom {
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-right: none;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }

    .btn-action {
        border-radius: 8px;
        font-weight: 500;
        padding: 10px 20px;
    }

    .table thead {
        background-color: #212529;
        color: white;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .bg-gradient-primary {
        background: linear-gradient(45deg, #0d6efd, #0b5ed7);
    }

    .bg-gradient-dark {
        background: linear-gradient(45deg, #343a40, #212529);
    }

    .total-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0d6efd;
    }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="bi bi-cart-check-fill me-2 text-primary"></i>Registrar Nueva Venta</h2>
        <div class="total-display p-2 px-4 bg-white rounded-pill shadow-sm border">
            TOTAL: <span class="text-primary">S/ </span><span id="TotalVenta">0.00</span>
        </div>
    </div>

    <form id="formVenta">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm-custom mb-4">
                    <div class="card-header bg-gradient-primary text-white py-3">
                        <i class="bi bi-person-lines-fill me-2"></i>Información del Cliente
                    </div>
                    <div class="card-body row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Tipo Documento</label>
                            <select id="TipoDocumento" class="form-select shadow-sm">
                                <option value="1">DNI</option>
                                <option value="2">RUC</option>
                                <option value="3">Carnet Extranjería</option>
                                <option value="4">Pasaporte</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Nro Documento</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                                <input type="text" id="NroDocumento" class="form-control" placeholder="Buscar..." maxlength="11" />
                                <button type="button" class="btn btn-primary" id="btnBuscarCliente">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <input type="hidden" id="EntidadClienteId" value="0" />

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Nombre / Razón Social</label>
                            <input type="text" id="NombreRazonSocial" class="form-control shadow-sm" />
                        </div>

                        <div class="col-md-8">
                            <label class="form-label fw-semibold">Dirección de Entrega</label>
                            <input type="text" id="Direccion" class="form-control shadow-sm" placeholder="Av. Principal 123..." />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Email de contacto</label>
                            <input type="email" id="Email" class="form-control shadow-sm" placeholder="cliente@correo.com" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Teléfono</label>
                            <input type="text" id="Telefono" class="form-control shadow-sm" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Fecha de Emisión</label>
                            <input type="date" id="Fecha" class="form-control shadow-sm text-center"
                                   value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Moneda</label>
                            <select id="Moneda" class="form-select shadow-sm">
                                <option value="PEN">Soles (PEN)</option>
                                <option value="USD">Dólares (USD)</option>
                            </select>
                        </div>
                        <input type="hidden" id="ImporteTotal" value="0.00" />
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm-custom bg-light border-info h-100">
                    <div class="card-header bg-info text-white py-3 text-center">
                        <i class="bi bi-file-earmark-arrow-down-fill me-2"></i>Importar Cotización
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center text-center">
                        <p class="text-muted small mb-3">Si el cliente tiene una cotización previa, ingrese el ID para cargar los productos automáticamente.</p>
                        <div class="mb-3">
                            <input type="text" id="txtIdCotizacion" class="form-control form-control-lg text-center shadow-sm" placeholder="ID #0000" oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                            <input type="hidden" id="IdCabeceraOrigen" value="0" />
                        </div>
                        <button type="button" id="btnCargarDesdeCotizacion" class="btn btn-info text-white btn-lg shadow-sm w-100">
                            <i class="bi bi-cloud-download-fill me-2"></i>Cargar Cotización
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm-custom mt-4 mb-4">
            <div class="card-header bg-gradient-dark text-white py-3">
                <i class="bi bi-box-seam me-2"></i>Añadir Productos al Detalle
            </div>

            <div class="card-body">
                <div class="row g-2 align-items-end mb-4 bg-light p-3 rounded-3 border">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Código de Barras</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                            <input type="text" id="CodigoBarras" class="form-control shadow-sm" placeholder="Escanear..." />
                            <button type="button" id="btnEscanear" class="btn btn-outline-dark">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold small">SKU / Código</label>
                        <div class="input-group">
                            <input type="text" id="SKU" class="form-control shadow-sm" />
                            <button type="button" class="btn btn-dark" id="btnBuscarProducto">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Descripción del Producto</label>
                        <input type="text" id="ProductoDescripcion" class="form-control shadow-sm" readonly />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label fw-bold small">Cantidad</label>
                        <input type="number" id="Cantidad" class="form-control shadow-sm text-center" min="1" value="1" oninput="validarPositivo(this)" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label fw-bold small">Precio</label>
                        <input type="number" id="PrecioUnitario" class="form-control shadow-sm text-end" step="0.01" />
                        <input type="hidden" id="PrecioOriginal" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label fw-bold small">Desc %</label>
                        <input type="number" id="Descuento" class="form-control shadow-sm text-center" min="0" max="100" step="0.01" value="0" oninput="validarPorcentaje(this)" />
                    </div>

                    <div class="col-md-1">
                        <button type="button" id="btnAgregar" class="btn btn-success w-100 shadow-sm">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive rounded-3 border">
                    <table class="table table-hover align-middle mb-0" id="tablaDetalle">
                        <thead class="bg-light">
                            <tr>
                                <th class="text-center" width="60">Item</th>
                                <th>Descripción</th>
                                <th width="150">Código Barras</th>
                                <th class="text-center" width="100">Cantidad</th>
                                <th class="text-end" width="120">P. Unitario</th>
                                <th class="text-center" width="100">Descuento</th>
                                <th class="text-end" width="120">Sub Total</th>
                                <th class="text-center" width="80"></th>
                            </tr>
                        </thead>
                        <tbody class="border-top-0">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-lg-6 mb-2">
                <button type="button" id="btnCancelar" class="btn btn-outline-danger btn-lg w-100 btn-action shadow-sm">
                    <i class="bi bi-trash3 me-2"></i>Cancelar Venta
                </button>
            </div>
            <div class="col-lg-3 mb-2">
                <button type="button" id="btnGuardar" class="btn btn-primary btn-lg w-100 btn-action shadow-sm">
                    <i class="bi bi-save me-2"></i>Solo Guardar
                </button>
            </div>
            <div class="col-lg-3 mb-2">
                <button type="button" id="btnEnviarSunat" class="btn btn-success btn-lg w-100 btn-action shadow-sm" onclick="enviarFacturaSunat()">
                    <i class="bi bi-cloud-upload-fill me-2"></i>Guardar y Enviar SUNAT
                </button>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="modalProductos" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-dark text-white">
                <h5 class="modal-title"><i class="bi bi-search me-2"></i>Catálogo de Productos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive p-2">
                    <table id="tblBuscarProductos" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Stock mín.</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let detalles = [];
        let contadorItem = 1;
        let tablaProductos;
        let modalProductos;

        // --- VALIDACIONES DE ENTRADA ---
        function validarPositivo(input) {
            if (input.value < 1) input.value = 1;
        }

        function validarPorcentaje(input) {
            if (input.value < 0) input.value = 0;
            if (input.value > 100) input.value = 100;
        }

        // --- CONFIGURACIÓN DE TIPO DE DOCUMENTO ---
        $("#TipoDocumento").change(function () {
            const tipo = $(this).val();
            const inputDoc = $("#NroDocumento");

            // Reiniciar campo
            inputDoc.val("");
            inputDoc.removeAttr("maxlength");
            inputDoc.removeAttr("oninput");

            if (tipo == "1") { // DNI
                inputDoc.attr("maxlength", "8");
                inputDoc.attr("placeholder", "8 dígitos");
                inputDoc.attr("oninput", "this.value = this.value.replace(/[^0-9]/g, '')");
            } else if (tipo == "2") { // RUC
                inputDoc.attr("maxlength", "11");
                inputDoc.attr("placeholder", "11 dígitos");
                inputDoc.attr("oninput", "this.value = this.value.replace(/[^0-9]/g, '')");
            } else {
                inputDoc.attr("placeholder", "Alfanumérico");
            }
        });
        $("#TipoDocumento").trigger("change");

        // --- FUNCIONES PRODUCTOS ---
        function limpiarProducto() {
            $("#CodigoBarras").val("");
            $("#SKU").val("");
            $("#ProductoDescripcion").val("");
            $("#Cantidad").val(1);
            $("#PrecioUnitario").val("");
            $("#PrecioOriginal").val("");
            $("#Descuento").val(0);
            $("#CodigoBarras").focus();
        }

        function actualizarTabla() {
            const tbody = $("#tablaDetalle tbody");
            tbody.empty();
            let total = 0;

            detalles.forEach((item, index) => {
                total += item.subtotal;
                tbody.append(`
                    <tr>
                        <td class="text-center">${item.item}</td>
                        <td>${item.descripcion}</td>
                        <td>${item.codigoBarras}</td>
                        <td class="text-center">${item.cantidad}</td>
                        <td class="text-end">${item.precioUnitario.toFixed(2)}</td>
                        <td class="text-center">${item.descuento.toFixed(2)}%</td>
                        <td class="text-end">${item.subtotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarItem(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });

            $("#TotalVenta").text(total.toFixed(2));
            $("#ImporteTotal").val(total.toFixed(2));
        }

        $("#btnAgregar").click(async function () {
            if (!validarCabecera()) return;

            const codigoBarras = $("#CodigoBarras").val().trim();
            const sku = $("#SKU").val().trim();
            const descripcion = $("#ProductoDescripcion").val().trim();
            const cantidad = parseFloat($("#Cantidad").val() || "0");
            const precioUnitario = parseFloat($("#PrecioUnitario").val() || "0");
            const precioOriginal = parseFloat($("#PrecioOriginal").val() || "0");
            const descuento = parseFloat($("#Descuento").val() || "0");

            if (!descripcion || cantidad <= 0 || precioUnitario <= 0) {
                Swal.fire('Atención', 'Seleccione un producto y verifique los datos.', 'warning');
                return;
            }

            // Alerta si el precio cambió
            if (precioOriginal > 0 && precioUnitario !== precioOriginal) {
                const confirmacion = await Swal.fire({
                    title: 'Precio Modificado',
                    text: `El precio original es S/ ${precioOriginal}. ¿Aplicar nuevo precio de S/ ${precioUnitario}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, cambiar',
                    cancelButtonText: 'No, restaurar'
                });

                if (!confirmacion.isConfirmed) {
                    $("#PrecioUnitario").val(precioOriginal);
                    return;
                }
            }

            let subtotalBruto = cantidad * precioUnitario;
            let montoDescuento = subtotalBruto * (descuento / 100.0);
            let subtotal = subtotalBruto - montoDescuento;

            detalles.push({
                item: contadorItem++,
                codigoBarras: codigoBarras,
                sku: sku,
                descripcion: descripcion,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                descuento: descuento, // Porcentaje
                subtotal: subtotal
            });

            actualizarTabla();
            limpiarProducto();
        });

        function eliminarItem(index) {
            Swal.fire({
                title: '¿Quitar producto?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Sí, quitar'
            }).then((result) => {
                if (result.isConfirmed) {
                    detalles.splice(index, 1);
                    detalles.forEach((item, idx) => item.item = idx + 1);
                    contadorItem = detalles.length + 1;
                    actualizarTabla();
                }
            });
        }
        window.eliminarItem = eliminarItem;

        function validarCabecera() {
            const nroDoc = $("#NroDocumento").val().trim();
            const nombre = $("#NombreRazonSocial").val().trim();
            const direccion = $("#Direccion").val().trim();
            const tipoDoc = $("#TipoDocumento").val();

            if (!nroDoc) { Swal.fire('Falta Dato', 'Ingrese el Nro de Documento', 'warning'); return false; }
            if (tipoDoc == "1" && nroDoc.length != 8) { Swal.fire('DNI Inválido', 'Debe tener 8 dígitos', 'error'); return false; }
            if (tipoDoc == "2" && nroDoc.length != 11) { Swal.fire('RUC Inválido', 'Debe tener 11 dígitos', 'error'); return false; }
            if (!nombre) { Swal.fire('Falta Dato', 'Ingrese Nombre o Razón Social', 'warning'); return false; }
            if (!direccion) { Swal.fire('Falta Dato', 'Ingrese la Dirección', 'warning'); return false; }

            return true;
        }

        // --- DATATABLE BUSQUEDA ---
        function initTablaProductos() {
            tablaProductos = $("#tblBuscarProductos").DataTable({
                ajax: {
                    url: "/Productos/ProductosLista_Controller",
                    type: "GET",
                    datatype: "json"
                },
                columns: [
                    { data: "sku" },
                    { data: "nombre" },
                    { data: "nombreCategoria" },
                    { data: "precio" },
                    { data: "stockMin" },
                    {
                        data: null,
                        render: function (data) {
                            // JSON.stringify seguro para pasar objetos
                            return `<button type='button' class='btn btn-success btn-sm' onclick='seleccionarProducto(${JSON.stringify(data)})'>Elegir</button>`;
                        },
                        orderable: false
                    }
                ],
                pageLength: 5,
                language: { url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" }
            });
        }

        window.seleccionarProducto = function (data) {
            $("#SKU").val(data.sku);
            $("#ProductoDescripcion").val(data.nombre);
            $("#PrecioUnitario").val(data.precio || 0);
            $("#PrecioOriginal").val(data.precio || 0);
            modalProductos.hide();
        };

        $(document).ready(function () {
            const modalEl = document.getElementById("modalProductos");
            if (modalEl) { modalProductos = new bootstrap.Modal(modalEl); }

            $("#btnBuscarProducto").click(function () {
                if (!tablaProductos) { initTablaProductos(); }
                modalProductos.show();
            });
        });

        // --- OBJETO VENTA COMPARTIDO ---
        function construirObjetoVenta() {
            return {
                tipoDocumento: "VEN",
                tipoMoneda: $("#Moneda").val(),
                direccion: $("#Direccion").val(),
                importeTotal: parseFloat($("#TotalVenta").text() || "0"),
                entidadCliente: parseInt($("#EntidadClienteId").val() || "0"),
                idTipoDocumentoCliente: parseInt($("#TipoDocumento").val() || "0"),
                nroDocumentoCliente: $("#NroDocumento").val(),
                nombreCliente: $("#NombreRazonSocial").val(),
                direccionCliente: $("#Direccion").val(),
                emailCliente: $("#Email").val(),
                telefonoCliente: $("#Telefono").val(),
                idCabeceraOrigen: parseInt($("#IdCabeceraOrigen").val() || "0"),
                detalle: detalles.map(d => {
                    const descuentoUnit = (d.precioUnitario * (d.descuento || 0)) / 100.0;
                    return {
                        item: d.item,
                        sku: d.sku,
                        cantidad: d.cantidad,
                        precioUnitario: d.precioUnitario,
                        descuento: descuentoUnit
                    };
                })
            };
        }

        // --- BOTÓN SOLO GUARDAR ---
        $("#btnGuardar").click(function () {
            if (!validarCabecera()) return;
            if (detalles.length === 0) { Swal.fire('Error', 'Agregue productos', 'error'); return; }

            const venta = construirObjetoVenta();

            Swal.fire({ title: 'Guardando', didOpen: () => Swal.showLoading() });

            $.ajax({
                url: "/Libreria/RegistrarVenta",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(venta),
                success: function (resp) {
                    Swal.close();
                    if (resp && resp.codMensaje == "1") {
                        Swal.fire('Correcto', resp.mensaje || "Venta registrada", 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Error', resp.mensaje, 'error');
                    }
                },
                error: function () { Swal.fire('Error', 'Error de conexión', 'error'); }
            });
        });

        // --- BOTÓN ENVIAR SUNAT ---
        function enviarFacturaSunat() {
            if (!validarCabecera()) return;
            if (detalles.length === 0) { Swal.fire('Error', 'No hay productos para facturar', 'error'); return; }

            // 1. Construir detalle específico para SUNAT con cálculos de IGV
            let totalIGV = 0;
            let valorVentaTotal = 0;
            const detallesSunat = [];

            detalles.forEach((d, index) => {
                const descuentoUnit = (d.precioUnitario * d.descuento) / 100;
                // Valor Unitario = PrecioUnitario - Descuento (sin IGV)
                // OJO: Aquí asumimos que el precio de la lista INCLUYE IGV.
                // Si tus precios NO incluyen IGV, elimina la división entre 1.18 abajo.

                // Si el precio unitario del input INCLUYE IGV:
                const precioConIgv = d.precioUnitario;
                const valorUnitarioSinIgv = precioConIgv / 1.18; // Desglosamos

                const valorVentaItem = d.cantidad * valorUnitarioSinIgv;
                const igvItem = valorVentaItem * 0.18;

                totalIGV += igvItem;
                valorVentaTotal += valorVentaItem;

                detallesSunat.push({
                    item: index + 1,
                    sku: d.sku,
                    unidad: "NIU", // Unidad bienes
                    descripcion: d.descripcion,
                    cantidad: d.cantidad,
                    precioUnitario: precioConIgv, // Precio con impuestos
                    mtoValorUnitario: valorUnitarioSinIgv.toFixed(2), // Valor sin impuestos
                    mtoValorVenta: valorVentaItem.toFixed(2),
                    mtoBaseIgv: valorVentaItem.toFixed(2),
                    porcentajeIgv: 18,
                    igv: igvItem.toFixed(2),
                    tipAfeIgv: 10, // Gravado - Operación Onerosa
                    totalImpuestos: igvItem.toFixed(2),
                    mtoPrecioUnitario: precioConIgv.toFixed(2)
                });
            });

            // 2. Construir JSON UBL
            const facturaJson = {
                ublVersion: "2.1",
                tipoOperacion: "0101",
                tipoDoc: "01", // Factura
                serie: "F001",
                correlativo: "0", // El backend o SUNAT lo asignará o enviamos 0
                fechaEmision: obtenerFechaEmision(),
                formaPago: { moneda: $("#Moneda").val(), tipo: "Contado" },
                tipoMoneda: $("#Moneda").val(),
                client: {
                    tipoDoc: $("#TipoDocumento").val() == "2" ? "6" : "1", // 6=RUC, 1=DNI
                    numDoc: $("#NroDocumento").val(),
                    rznSocial: $("#NombreRazonSocial").val(),
                    address: {
                        direccion: $("#Direccion").val(),
                        ubigueo: "150101", // Default o dinámico
                        provincia: "LIMA",
                        departamento: "LIMA",
                        distrito: "LIMA"
                    }
                },
                company: {
                    ruc: "10703784882", // TU RUC EMISOR
                    razonSocial: "Francisco Jesus Sonco Montes",
                    nombreComercial: "LIBRERIAS EXPORT SAC",
                    address: {
                        direccion: "Direccion empresa",
                        ubigueo: "040401",
                        provincia: "AREQUIPA",
                        departamento: "AREQUIPA",
                        distrito: "AREQUIPA"
                    }
                },
                mtoIGV: totalIGV.toFixed(2),
                totalImpuestos: totalIGV.toFixed(2),
                valorVenta: valorVentaTotal.toFixed(2),
                subTotal: valorVentaTotal.toFixed(2),
                mtoImpVenta: (valorVentaTotal + totalIGV).toFixed(2),
                details: detallesSunat,
                legends: [{ code: "1002", value: "SON " + detalles.length + " ITEMS" }]
            };

            Swal.fire({
                title: 'Enviando a SUNAT',
                html: 'Generando comprobante electrónico...<br><b>No cierre la ventana</b>',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // 3. Enviar al Backend
            $.ajax({
                url: '/api/GenerarDoc/FacturaElectronicaGenerar', // Tu Endpoint del primer código
                type: 'POST',
                data: JSON.stringify(facturaJson),
                contentType: 'application/json; charset=utf-8',
                xhrFields: { responseType: 'blob' }, // IMPORTANTE PARA EL PDF
                success: function (data, status, xhr) {
                    Swal.close();

                    // Manejar descarga del PDF
                    let fileName = "FacturaElectronica.pdf";
                    const disposition = xhr.getResponseHeader('Content-Disposition');
                    if (disposition && disposition.includes('filename=')) {
                        fileName = disposition.split('filename=')[1].replace(/"/g, '');
                    }

                    const blob = new Blob([data], { type: 'application/pdf' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                    Swal.fire('Éxito', 'Factura generada y descargada.', 'success')
                        .then(() => location.reload());
                },
                error: function () {
                    Swal.fire('Error SUNAT', 'No se pudo generar el comprobante o fue rechazado.', 'error');
                }
            });
        }

        // --- UTILIDADES ---
        function obtenerFechaEmision() {
            const ahora = new Date();
            const offsetMs = ahora.getTimezoneOffset() * 60000;
            const peruTime = new Date(ahora.getTime() - offsetMs - (5 * 60 * 60000));
            return peruTime.toISOString().slice(0, 19) + "-05:00";
        }

        // --- CLIENTE POR RUC (Fallback API externa si falla local) ---
        function consultarRuc() {
            const ruc = $('#NroDocumento').val();
            Swal.showLoading();
            $.get(`/api/ApiSunat/consultar-ruc/${ruc}`, function (resp) {
                Swal.close();
                if (resp.success) {
                    $('#NombreRazonSocial').val(resp.razonSocial);
                    $('#Direccion').val(resp.direccion);
                } else {
                    Swal.fire('Aviso', resp.message, 'warning');
                }
            }).fail(() => {
                Swal.fire('Error', 'No se pudo consultar el RUC externamente', 'error');
            });
        }

        // --- BUSQUEDA CLIENTE PRINCIPAL ---
        $("#btnBuscarCliente").click(function () {
            const nro = $("#NroDocumento").val().trim();
            if (!nro) { Swal.fire('Aviso', "Ingrese Nro Documento", 'warning'); return; }

            // Si es RUC (11 dígitos), intentamos lógica inteligente
            if (nro.length === 11) {
                // Primero buscamos local, si no, intentamos API externa (consultarRuc)
                $.ajax({
                    url: "/Libreria/ClienteBuscarPorDocumento",
                    type: "GET",
                    data: { nroDocumento: nro },
                    success: function (res) {
                        if (res && res.encontrado) {
                            // Encontrado localmente
                            const c = res.cliente;
                            $("#EntidadClienteId").val(c.entidadId);
                            $("#NombreRazonSocial").val(c.nombreRazon);
                            $("#Direccion").val(c.direccion);
                            $("#Email").val(c.email);
                            $("#Telefono").val(c.telefono);
                        } else {
                            // No encontrado localmente, intentar API SUNAT
                            consultarRuc();
                        }
                    },
                    error: function() { consultarRuc(); } // Si falla local, intentar externo
                });
            } else {
                // Lógica DNI Normal
                $.ajax({
                    url: "/Libreria/ClienteBuscarPorDocumento",
                    type: "GET",
                    data: { nroDocumento: nro },
                    success: function (res) {
                        if (res && res.encontrado) {
                            const c = res.cliente;
                            $("#EntidadClienteId").val(c.entidadId);
                            $("#NombreRazonSocial").val(c.nombreRazon);
                            $("#Direccion").val(c.direccion);
                            $("#Email").val(c.email);
                            $("#Telefono").val(c.telefono);
                        } else {
                            Swal.fire('No encontrado', 'Cliente no registrado', 'info');
                        }
                    }
                });
            }
        });

        $("#btnCancelar").click(function () {
            if (detalles.length > 0) {
                Swal.fire({
                    title: '¿Cancelar?', text: "Se perderán los datos", icon: 'warning',
                    showCancelButton: true, confirmButtonText: 'Sí'
                }).then((r) => { if (r.isConfirmed) location.reload(); });
            } else { location.reload(); }
        });

        // Cargar Cotización
        $("#btnCargarDesdeCotizacion").click(function () {
            const id = parseInt($("#txtIdCotizacion").val() || "0");
            if (!id) { Swal.fire('Error', "ID inválido", 'error'); return; }

            Swal.showLoading();
            $.get("/Libreria/CotizacionObtener", { idCabecera: id }, function (resp) {
                Swal.close();
                if (!resp || !resp.encontrado) { Swal.fire('Error', "Cotización no encontrada", 'error'); return; }

                const c = resp.cabecera;
                $("#EntidadClienteId").val(c.entidadCliente);
                $("#TipoDocumento").val(c.idTipoDocumentoCliente).trigger('change');
                $("#NroDocumento").val(c.nroDocumentoCliente);
                $("#NombreRazonSocial").val(c.nombreCliente);
                $("#Direccion").val(c.direccionCliente);
                $("#Email").val(c.emailCliente);
                $("#Telefono").val(c.telefonoCliente);
                $("#Moneda").val(c.tipoMoneda || "PEN");
                $("#IdCabeceraOrigen").val(c.idCabecera);

                detalles = [];
                contadorItem = 1;
                if (resp.detalle) {
                    resp.detalle.forEach(d => {
                        const cant = d.cantidad || 0;
                        const pUnit = d.precioUnitario || 0;
                        const descUnit = d.descuento || 0;
                        const sub = (cant * pUnit) - (cant * descUnit);
                        const descPct = pUnit > 0 ? (descUnit / pUnit) * 100 : 0;

                        detalles.push({
                            item: contadorItem++, sku: d.sku, descripcion: d.descripcion, codigoBarras: "",
                            cantidad: cant, precioUnitario: pUnit, descuento: descPct, subtotal: sub
                        });
                    });
                }
                actualizarTabla();
                Swal.fire('Cargado', 'Cotización importada', 'success');
            });
        });

    </script>
}