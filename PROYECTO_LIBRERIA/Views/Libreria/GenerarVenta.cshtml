@{
    ViewData["Title"] = "GenerarVenta";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h3 class="mb-3">Registrar Venta</h3>

    <form id="formVenta">
        <!-- ===================== CABECERA ===================== -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                Datos del Cliente
            </div>
            <div class="card-body row g-3">
                <div class="col-md-3">
                    <label class="form-label">Tipo Documento</label>
                    <select id="TipoDocumento" class="form-select">
                        <option value="1">DNI</option>
                        <option value="2">RUC</option>
                        <option value="3">Carnet Extranjería</option>
                        <option value="4">Pasaporte</option>
                    </select>
                </div>

                <!-- BUSCAR CLIENTE POR DOCUMENTO DE IDENTIDAD -->
                <div class="col-md-3">
                    <label class="form-label">Nro Documento</label>
                    <div class="input-group">
                        <input type="text" id="NroDocumento" class="form-control" required />
                        <button type="button" class="btn btn-outline-secondary" id="btnBuscarCliente">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>

                <input type="hidden" id="EntidadClienteId" />

                <div class="col-md-6">
                    <label class="form-label">Nombre / Razón Social</label>
                    <input type="text" id="NombreRazonSocial" class="form-control" required />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Dirección</label>
                    <input type="text" id="Direccion" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="Email" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Teléfono</label>
                    <input type="text" id="Telefono" class="form-control" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Fecha</label>
                    <input type="date" id="Fecha" class="form-control"
                           value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-3">
                    <label class="form-label">Moneda</label>
                    <select id="Moneda" class="form-select">
                        <option value="PEN">Soles (PEN)</option>
                        <option value="USD">Dólares (USD)</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Importe Total</label>
                    <input type="text" id="ImporteTotal" class="form-control" value="0.00" readonly />
                </div>
            </div>
        </div>

        <!-- ===================== DETALLE ===================== -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white">
                Agregar Productos al Detalle
            </div>

            <div class="card-body">
                <!-- Formulario para agregar productos -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Código de Barras</label>
                        <div class="input-group">
                            <input type="text" id="CodigoBarras" class="form-control" placeholder="Escanear código" />
                            <button type="button" id="btnEscanear" class="btn btn-outline-secondary">
                                <i class="fas fa-barcode"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">SKU</label>
                        <div class="input-group">
                            <input type="text" id="SKU" class="form-control" />
                            <button type="button" class="btn btn-outline-secondary" id="btnBuscarProducto">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Producto / Descripción</label>
                        <input type="text" id="ProductoDescripcion" class="form-control" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label">Cantidad</label>
                        <input type="number" id="Cantidad" class="form-control" min="1" value="1" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label">Precio Unit.</label>
                        <input type="number" id="PrecioUnitario" class="form-control" step="0.01" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label">Descuento %</label>
                        <input type="number" id="Descuento" class="form-control" min="0" max="100" step="0.01" value="0" />
                    </div>

                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" id="btnAgregar" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                </div>

                <!-- Tabla de Detalle -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="tablaDetalle">
                        <thead class="table-secondary">
                            <tr>
                                <th width="50">Item</th>
                                <th>Producto / Descripción</th>
                                <th width="150">Código Barras</th>
                                <th width="100">Cantidad</th>
                                <th width="120">Precio Unit.</th>
                                <th width="100">Descuento %</th>
                                <th width="120">Sub Total</th>
                                <th width="80">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr class="table-active">
                                <td colspan="6" class="text-end"><strong>TOTAL:</strong></td>
                                <td><strong id="TotalVenta">0.00</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===================== BLOQUE: CARGAR DESDE COTIZACIÓN ===================== -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                Cargar datos desde una Cotización
            </div>
            <div class="card-body row g-3">
                <div class="col-md-3">
                    <label class="form-label">ID Cotización</label>
                    <input type="number" id="txtIdCotizacion" class="form-control" />
                    <input type="hidden" id="IdCabeceraOrigen" value="0" />    <!-- ======================================================== -->
                            </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" id="btnCargarDesdeCotizacion" class="btn btn-outline-primary w-100">
                        Cargar desde cotización
                    </button>
                </div>
            </div>
        </div>

        <!-- BOTONES DE ACCIÓN -->
        <div class="d-flex justify-content-between">
            <button type="button" id="btnCancelar" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" id="btnGuardar" class="btn btn-primary">
                <i class="fas fa-save"></i> Guardar Venta
            </button>
        </div>
    </form>
</div>

<!-- ===================== MODAL BUSCAR PRODUCTOS ===================== -->
<div class="modal fade" id="modalProductos" tabindex="-1" aria-labelledby="modalProductosLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalProductosLabel">Seleccionar producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <table id="tblBuscarProductos" class="table table-striped table-bordered w-100">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Stock mín.</th>
                            <th style="width: 80px;">Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let detalles = [];
        let contadorItem = 1;
        let tablaProductos;
        let modalProductos;

        function limpiarProducto() {
            $("#CodigoBarras").val("");
            $("#SKU").val("");
            $("#ProductoDescripcion").val("");
            $("#Cantidad").val(1);
            $("#PrecioUnitario").val("");
            $("#Descuento").val(0);
            $("#CodigoBarras").focus();
        }

        function actualizarTabla() {
            const tbody = $("#tablaDetalle tbody");
            tbody.empty();

            let total = 0;

            detalles.forEach((item, index) => {
                total += item.subtotal;

                tbody.append(`
                    <tr>
                        <td class="text-center">${item.item}</td>
                        <td>${item.descripcion}</td>
                        <td>${item.codigoBarras}</td>
                        <td class="text-center">${item.cantidad}</td>
                        <td class="text-end">${item.precioUnitario.toFixed(2)}</td>
                        <td class="text-center">${item.descuento.toFixed(2)}%</td>
                        <td class="text-end">${item.subtotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });

            $("#TotalVenta").text(total.toFixed(2));
            $("#ImporteTotal").val(total.toFixed(2));
        }

        $("#btnAgregar").click(function () {
            const codigoBarras = $("#CodigoBarras").val().trim();
            const sku = $("#SKU").val().trim();
            const descripcion = $("#ProductoDescripcion").val().trim();
            const cantidad = parseFloat($("#Cantidad").val() || "0");
            const precioUnitario = parseFloat($("#PrecioUnitario").val() || "0");
            const descuento = parseFloat($("#Descuento").val() || "0");

            if (!descripcion || cantidad <= 0 || precioUnitario <= 0) {
                alert("Completa los datos del producto.");
                return;
            }

            let subtotalBruto = cantidad * precioUnitario;
            let montoDescuento = subtotalBruto * (descuento / 100.0);
            let subtotal = subtotalBruto - montoDescuento;

            detalles.push({
                item: contadorItem++,
                codigoBarras: codigoBarras,
                sku: sku,
                descripcion: descripcion,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                descuento: descuento,
                subtotal: subtotal
            });

            actualizarTabla();
            limpiarProducto();
        });

        function eliminarItem(index) {
            if (!confirm("¿Eliminar este producto?")) return;

            detalles.splice(index, 1);
            detalles.forEach((item, idx) => item.item = idx + 1);
            contadorItem = detalles.length + 1;
            actualizarTabla();
        }

        window.eliminarItem = eliminarItem;

        function initTablaProductos() {
            tablaProductos = $("#tblBuscarProductos").DataTable({
                ajax: {
                    url: "/Productos/ProductosLista_Controller",
                    type: "GET",
                    datatype: "json"
                },
                columns: [
                    { data: "sku" },
                    { data: "nombre" },
                    { data: "nombreCategoria" },
                    { data: "precio" },
                    { data: "stockMin" },
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            return `
                                <button type="button" class="btn btn-success btn-sm"
                                        onclick="seleccionarProducto(${meta.row})">
                                    Elegir
                                </button>`;
                        },
                        orderable: false,
                        searchable: false
                    }
                ],
                pageLength: 10,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-MX.json"
                }
            });
        }

        function seleccionarProducto(rowIndex) {
            const data = tablaProductos.row(rowIndex).data();
            if (!data) return;

            $("#SKU").val(data.sku);
            $("#ProductoDescripcion").val(data.nombre);
            $("#PrecioUnitario").val(data.precio || 0);

            modalProductos.hide();
        }

        window.seleccionarProducto = seleccionarProducto;

        $(document).ready(function () {
            const modalProductosEl = document.getElementById("modalProductos");
            if (modalProductosEl) {
                modalProductos = new bootstrap.Modal(modalProductosEl);
            }

            $("#btnBuscarProducto").click(function () {
                if (!tablaProductos) {
                    initTablaProductos();
                }
                modalProductos.show();
            });
        });

        $("#btnGuardar").click(function () {
            if (detalles.length === 0) {
                alert("Agrega al menos un producto al detalle.");
                return;
            }

            let venta = {
                tipoDocumento: "VEN",
                tipoMoneda: $("#Moneda").val(),
                direccion: $("#Direccion").val(),
                importeTotal: parseFloat($("#TotalVenta").text() || "0"),

                entidadCliente: parseInt($("#EntidadClienteId").val() || "0"),

                idTipoDocumentoCliente: parseInt($("#TipoDocumento").val() || "0"),
                nroDocumentoCliente: $("#NroDocumento").val(),
                nombreCliente: $("#NombreRazonSocial").val(),
                direccionCliente: $("#Direccion").val(),
                emailCliente: $("#Email").val(),
                telefonoCliente: $("#Telefono").val(),
                // NUEVO: ID de la cotización de origen (o 0 si no viene de ninguna)
                idCabeceraOrigen: parseInt($("#IdCabeceraOrigen").val() || "0"),

                 detalle: detalles.map(d => {
                 const descuentoUnit = (d.precioUnitario * (d.descuento || 0)) / 100.0; // % -> monto unitario
                    return {
                        item: d.item,
                        sku: d.sku,
                        cantidad: d.cantidad,
                        precioUnitario: d.precioUnitario,
                        descuento: descuentoUnit
                    };
                 })

            };

            $.ajax({
                url: "/Libreria/RegistrarVenta",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(venta),
                success: function (resp) {
                    if (resp && (resp.codMensaje === "1" || resp.codMensaje === 1)) {
                        alert(resp.mensaje || "Venta registrada correctamente.");
                        location.reload();
                    } else {
                        alert(resp.mensaje || "Ocurrió un problema al registrar la venta.");
                    }
                },
                error: function () {
                    alert("Error al registrar la venta.");
                }
            });
        });

        $("#btnCancelar").click(function () {
            if (detalles.length > 0 && !confirm("¿Cancelar la venta? Se perderán los datos.")) {
                return;
            }
            location.reload();
        });

        // Buscar cliente por DNI/RUC
        $("#btnBuscarCliente").click(function () {
            const nro = $("#NroDocumento").val().trim();

            if (!nro) {
                alert("Ingresa el Nro de Documento.");
                return;
            }

            $.ajax({
                url: "/Libreria/ClienteBuscarPorDocumento",
                type: "GET",
                data: { nroDocumento: nro },
                success: function (res) {
                    if (!res || !res.encontrado) {
                        alert("Cliente no encontrado.");
                        $("#EntidadClienteId").val("");
                        return;
                    }

                    const c = res.cliente;
                    $("#EntidadClienteId").val(c.entidadId);
                    $("#NombreRazonSocial").val(c.nombreRazon);
                    $("#Direccion").val(c.direccion);
                    $("#Email").val(c.email);
                    $("#Telefono").val(c.telefono);
                    $("#TipoDocumento").val(c.idTipoDocumento);
                },
                error: function () {
                    alert("Error al buscar el cliente.");
                }
            });
        });

        // Cargar desde cotización
        $("#btnCargarDesdeCotizacion").click(function () {
            const id = parseInt($("#txtIdCotizacion").val() || "0");
            if (!id) {
                alert("Ingresa un ID de cotización.");
                return;
            }

            $.get("/Libreria/CotizacionObtener", { idCabecera: id }, function (resp) {
                if (!resp || !resp.encontrado) {
                    alert("No se encontró la cotización.");
                    return;
                }

                const c = resp.cabecera;

                $("#EntidadClienteId").val(c.entidadCliente);
                $("#TipoDocumento").val(c.idTipoDocumentoCliente);
                $("#NroDocumento").val(c.nroDocumentoCliente);
                $("#NombreRazonSocial").val(c.nombreCliente);
                $("#Direccion").val(c.direccionCliente);
                $("#Email").val(c.emailCliente);
                $("#Telefono").val(c.telefonoCliente);
                $("#Moneda").val(c.tipoMoneda || "PEN");
                // Guarda el ID de la cotización como origen
                $("#IdCabeceraOrigen").val(c.idCabecera || 0);  //////////////////////////////////////////////////////
                // Rellenar detalle
                detalles = [];
                contadorItem = 1;

                if (resp.detalle && resp.detalle.length > 0) {
                        resp.detalle.forEach(d => {
                             const cantidad = d.cantidad || 0;
                             const precioUnitario = d.precioUnitario || 0;

                        // BD devuelve descuento como MONTO UNITARIO
                        const descuentoUnit = d.descuento || 0;

                        // Convertimos a % para mostrar en UI
                        const descuentoPct = precioUnitario > 0 ? (descuentoUnit / precioUnitario) * 100.0 : 0;

                        const subtotalBruto = cantidad * precioUnitario;
                        const montoDesc = cantidad * descuentoUnit; // monto unitario * cantidad
                        const subtotal = subtotalBruto - montoDesc;

                        detalles.push({
                            item: contadorItem++,
                            codigoBarras: "",
                            sku: d.sku,
                            descripcion: d.descripcion || "",
                            cantidad: cantidad,
                            precioUnitario: precioUnitario,
                            descuento: descuentoPct, // UI muestra %
                            subtotal: subtotal
                        });
                    });

                }

                actualizarTabla();
            }).fail(function () {
                alert("Error al buscar la cotización.");
            });
        });
    </script>
}
