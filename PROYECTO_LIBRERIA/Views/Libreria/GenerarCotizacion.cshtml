@{
    ViewData["Title"] = "Generar Cotización";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Estilos de coherencia visual con Generar Venta */
    .card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .card-header {
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .shadow-sm-custom {
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-right: none;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }

    .btn-action {
        border-radius: 8px;
        font-weight: 500;
        padding: 10px 20px;
    }

    .table thead {
        background-color: #212529;
        color: white;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .bg-gradient-primary {
        background: linear-gradient(45deg, #0d6efd, #0b5ed7);
    }

    .bg-gradient-dark {
        background: linear-gradient(45deg, #343a40, #212529);
    }

    .total-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0d6efd;
    }
</style>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="bi bi-file-earmark-text-fill me-2 text-primary"></i>Registrar Cotización</h2>
        <div class="total-display p-2 px-4 bg-white rounded-pill shadow-sm border">
            TOTAL COTIZACIÓN: <span class="text-primary">S/ </span><span id="TotalCotizacion">0.00</span>
        </div>
    </div>

    <form id="formCotizacion">
        <div class="card shadow-sm-custom mb-4">
            <div class="card-header bg-gradient-primary text-white py-3">
                <i class="bi bi-person-lines-fill me-2"></i>Datos de la Cotización
            </div>

            <div class="card-body row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Cliente / Razón Social</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input type="text" id="Cliente" class="form-control" placeholder="Nombre del cliente" required />
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-semibold">RUC / DNI</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text"><i class="bi bi-card-text"></i></span>
                        <input type="text" id="Documento" class="form-control" placeholder="Nro de documento" />
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-semibold">Fecha Emisión</label>
                    <input type="date" id="Fecha" class="form-control shadow-sm text-center"
                           value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-2">
                    <label class="form-label fw-semibold">Moneda</label>
                    <select id="Moneda" class="form-select shadow-sm">
                        <option value="PEN">Soles (PEN)</option>
                        <option value="USD">Dólares (USD)</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-semibold">Contacto / Atención</label>
                    <input type="text" id="Atencion" class="form-control shadow-sm" placeholder="Persona de contacto" />
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-semibold">Validez (días)</label>
                    <div class="input-group shadow-sm">
                        <input type="number" id="Validez" class="form-control text-center" value="7" />
                        <span class="input-group-text">Días</span>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Condiciones de Pago / Observaciones</label>
                    <input type="text" id="Condiciones" class="form-control shadow-sm" placeholder="Ej: Pago contra entrega, 50% adelanto..." />
                </div>
            </div>
        </div>

        <div class="card shadow-sm-custom mb-4 border-top-0">
            <div class="card-header bg-gradient-dark text-white py-3">
                <i class="bi bi-box-seam me-2"></i>Detalle de Productos
            </div>

            <div class="card-body">
                <div class="row g-2 align-items-end mb-4 bg-light p-3 rounded-3 border">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Código de Barras</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                            <input type="text" id="CodigoBarras" class="form-control shadow-sm" placeholder="Escanear..." />
                            <button type="button" class="btn btn-outline-dark">
                                <i class="bi bi-camera"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold small">SKU</label>
                        <div class="input-group shadow-sm">
                            <input type="text" id="SKU" class="form-control" />
                            <button type="button" class="btn btn-dark" id="btnBuscarProducto">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Producto / Descripción</label>
                        <input type="text" id="ProductoDescripcion" class="form-control shadow-sm" readonly />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label fw-bold small">Cant.</label>
                        <input type="number" id="Cantidad" class="form-control shadow-sm text-center" value="1" min="1" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label fw-bold small">Precio</label>
                        <input type="number" id="PrecioUnitario" class="form-control shadow-sm text-end" step="0.01" />
                    </div>

                    <div class="col-md-1">
                        <label class="form-label fw-bold small">Desc %</label>
                        <input type="number" id="Descuento" class="form-control shadow-sm text-center" value="0" min="0" max="100" step="0.01" />
                    </div>

                    <div class="col-md-1">
                        <button type="button" id="btnAgregar" class="btn btn-success w-100 shadow-sm">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive rounded-3 border">
                    <table class="table table-hover align-middle mb-0" id="tablaDetalle">
                        <thead class="bg-light">
                            <tr>
                                <th class="text-center" width="60">Item</th>
                                <th>Producto / Descripción</th>
                                <th width="150">Código Barras</th>
                                <th class="text-center" width="90">Cant.</th>
                                <th class="text-end" width="120">Precio</th>
                                <th class="text-center" width="100">Desc. %</th>
                                <th class="text-end" width="120">Subtotal</th>
                                <th class="text-center" width="60"></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-6">
                <button type="button" id="btnCancelar" class="btn btn-outline-danger btn-lg w-100 btn-action shadow-sm">
                    <i class="bi bi-x-circle me-2"></i>Cancelar Cotización
                </button>
            </div>
            <div class="col-6">
                <button type="button" id="btnGuardar" class="btn btn-primary btn-lg w-100 btn-action shadow-sm">
                    <i class="bi bi-save-fill me-2"></i>Guardar Cotización
                </button>
            </div>
        </div>

    </form>
</div>

<div class="modal fade" id="modalProductos" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-dark text-white">
                <h5 class="modal-title"><i class="bi bi-search me-2"></i>Catálogo de Productos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive p-2">
                    <table id="tblBuscarProductos" class="table table-striped table-hover w-100">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Stock mín.</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let detalles = [];
        let contadorItem = 1;
        let tablaProductos;
        let modalProductos;

        function limpiarProducto() {
            $("#CodigoBarras").val("");
            $("#SKU").val("");
            $("#ProductoDescripcion").val("");
            $("#Cantidad").val(1);
            $("#PrecioUnitario").val("");
            $("#Descuento").val(0);
            $("#CodigoBarras").focus();
        }

        function actualizarTabla() {
            const tbody = $("#tablaDetalle tbody");
            tbody.empty();

            let total = 0;

            detalles.forEach((item, index) => {
                total += item.subtotal;

                tbody.append(`
                    <tr>
                        <td class="text-center">${item.item}</td>
                        <td>${item.descripcion}</td>
                        <td>${item.codigoBarras}</td>
                        <td class="text-center">${item.cantidad}</td>
                        <td class="text-end">${item.precioUnitario.toFixed(2)}</td>
                        <td class="text-center">${item.descuento.toFixed(2)}%</td>
                        <td class="text-end">${item.subtotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm"
                                    onclick="eliminarItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });

            $("#TotalCotizacion").text(total.toFixed(2));
        }

        $("#btnAgregar").click(function () {
            const codigoBarras = $("#CodigoBarras").val().trim();
            const sku = $("#SKU").val().trim();
            const descripcion = $("#ProductoDescripcion").val().trim();
            const cantidad = parseFloat($("#Cantidad").val() || "0");
            const precioUnitario = parseFloat($("#PrecioUnitario").val() || "0");
            const descuento = parseFloat($("#Descuento").val() || "0");

            if (!descripcion || cantidad <= 0 || precioUnitario <= 0) {
                alert("Completa los datos del producto.");
                return;
            }

            let subtotalBruto = cantidad * precioUnitario;
            let montoDescuento = subtotalBruto * (descuento / 100.0);
            let subtotal = subtotalBruto - montoDescuento;

            detalles.push({
                item: contadorItem++,
                codigoBarras: codigoBarras,
                sku: sku,
                descripcion: descripcion,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                descuento: descuento,
                subtotal: subtotal
            });

            actualizarTabla();
            limpiarProducto();
        });

        function eliminarItem(index) {
            if (!confirm("¿Eliminar este producto?")) return;

            detalles.splice(index, 1);
            detalles.forEach((item, idx) => item.item = idx + 1);
            contadorItem = detalles.length + 1;
            actualizarTabla();
        }

        window.eliminarItem = eliminarItem;

        function initTablaProductos() {
            tablaProductos = $("#tblBuscarProductos").DataTable({
                ajax: {
                    url: "/Productos/ProductosLista_Controller",
                    type: "GET",
                    datatype: "json"
                },
                columns: [
                    { data: "sku" },
                    { data: "nombre" },
                    { data: "nombreCategoria" },
                    { data: "precio" },
                    { data: "stockMin" },
                    {
                        data: null,
                        render: function (data, type, row, meta) {
                            return `
                                <button type="button" class="btn btn-success btn-sm"
                                        onclick="seleccionarProducto(${meta.row})">
                                    Elegir
                                </button>`;
                        },
                        orderable: false,
                        searchable: false
                    }
                ],
                pageLength: 10,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-MX.json"
                }
            });
        }

        function seleccionarProducto(rowIndex) {
            const data = tablaProductos.row(rowIndex).data();
            if (!data) return;

            $("#SKU").val(data.sku);
            $("#ProductoDescripcion").val(data.nombre);
            $("#PrecioUnitario").val(data.precio || 0);

            modalProductos.hide();
        }

        window.seleccionarProducto = seleccionarProducto;

        $(document).ready(function () {
            const modalProductosEl = document.getElementById("modalProductos");
            if (modalProductosEl) {
                modalProductos = new bootstrap.Modal(modalProductosEl);
            }

            $("#btnBuscarProducto").click(function () {
                if (!tablaProductos) {
                    initTablaProductos();
                }
                modalProductos.show();
            });
        });

        function inferirTipoDocId(valor) {
            const doc = (valor || "").trim();
            if (doc.length === 11) return 2; // RUC
            if (doc.length === 8)  return 1; // DNI
            return 1;
        }

        $("#btnGuardar").click(function () {
            if (detalles.length === 0) {
                alert("Agrega al menos un producto.");
                return;
            }

            const rucDni = $("#Documento").val().trim();
            const clienteNombre = $("#Cliente").val().trim();
            const diasValidez = parseInt($("#Validez").val() || "0");

            if (!rucDni || !clienteNombre) {
                alert("Ingresa RUC/DNI y nombre de cliente.");
                return;
            }

            let cot = {
                tipoDocumento: "COT",
                tipoMoneda: $("#Moneda").val(),
                direccion: null,
                importeTotal: parseFloat($("#TotalCotizacion").text() || "0"),

                entidadCliente: 0,

                idTipoDocumentoCliente: inferirTipoDocId(rucDni),
                nroDocumentoCliente: rucDni,
                nombreCliente: clienteNombre,
                direccionCliente: null,
                emailCliente: null,
                telefonoCliente: null,

                diasValidez: isNaN(diasValidez) ? 0 : diasValidez,
                idCabeceraOrigen: 0,

                detalle: detalles.map(d => {
                const descuentoUnit = (d.precioUnitario * (d.descuento || 0)) / 100.0; // % -> monto unitario
                    return {
                     item: d.item,
                     sku: d.sku,
                     cantidad: d.cantidad,
                     precioUnitario: d.precioUnitario,
                     descuento: descuentoUnit
                    };
                })

            };

            $.ajax({
                url: "/Libreria/RegistrarCotizacion",
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(cot),
                success: function (resp) {
                    if (resp && (resp.codMensaje === "1" || resp.codMensaje === 1)) {
                        alert(resp.mensaje || "Cotización registrada correctamente.");
                        location.reload();
                    } else {
                        alert(resp.mensaje || "Ocurrió un problema al registrar la cotización.");
                    }
                },
                error: function () {
                    alert("Error al registrar la cotización.");
                }
            });
        });

        $("#btnCancelar").click(function () {
            if (detalles.length > 0 && !confirm("¿Cancelar la cotización? Se perderán los datos.")) {
                return;
            }
            location.reload();
        });
    </script>
}
