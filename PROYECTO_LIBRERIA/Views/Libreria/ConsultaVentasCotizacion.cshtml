

@model LIBRERIA_APP.Models.LibreriaModel
@{
    ViewData["Title"] = "Consulta de Ventas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .card {
        border: none;
        border-radius: 12px;
    }

    .bg-gradient-dark {
        background: linear-gradient(45deg, #343a40, #212529);
    }

    .shadow-custom {
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
</style>

<div class="container-fluid mt-4">
    <div class="card shadow-custom">
        <div class="card-header bg-gradient-dark text-white d-flex justify-content-between align-items-center py-3">
            <h4 class="mb-0"><i class="bi bi-search me-2"></i>Consulta de Ventas Realizadas</h4>
            <div class="btn-group shadow-sm">
                <button class="btn btn-outline-light btn-sm px-3" onclick="CargarTabla('DIA')">Hoy</button>
                <button class="btn btn-outline-light btn-sm px-3" onclick="CargarTabla('SEMANA')">Semana</button>
                <button class="btn btn-outline-light btn-sm px-3" onclick="CargarTabla('MES')">Este Mes</button>
                <button class="btn btn-outline-light btn-sm px-3" onclick="CargarTabla('TODOS')">Ver Todo</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tblConsultaVentas" class="table table-hover align-middle w-100">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Fecha Registro</th>
                            <th>Documento</th>
                            <th>Cliente</th>
                            <th>Moneda</th>
                            <th>Total</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalleVenta" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div id="areaImpresion">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">COMPROBANTE DE VENTA #<span id="txtIdVenta"></span></h5>
                </div>
                <div class="modal-body">
                    <div id="cuerpoDetalle">
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button class="btn btn-danger" onclick="ExportarPDF()"><i class="bi bi-file-pdf me-1"></i>Descargar PDF</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Cargar ventas del día por defecto
            CargarTabla('DIA');
        });

        function CargarTabla(filtro) {
            // Destruir tabla previa si existe para recargar
            if ($.fn.DataTable.isDataTable('#tblConsultaVentas')) {
                $('#tblConsultaVentas').DataTable().destroy();
            }

            $('#tblConsultaVentas').DataTable({
                "ajax": {
                    "url": "@Url.Action("ListarVentasCot", "Libreria")",
                    "type": "GET",
                    "data": { filtro: filtro }
                },
                "columns": [
                    { "data": "idCabecera" },
                    { "data": "mensaje" }, // Fecha
                    {
                        "data": "tipoDocumento",
                        "render": function(data) {
                            return data === 'Venta'
                                ? '<span class="badge bg-success">Venta</span>'
                                : '<span class="badge bg-warning text-dark">Cotización</span>';
                        }
                    },
                    { "data": "nroDocumentoCliente" },
                    { "data": "nombreCliente" },
                    { "data": "tipoMoneda" },
                    { "data": "importeTotal", "render": $.fn.dataTable.render.number(',', '.', 2, '') },
                    {
                        "data": "idCabecera",
                        "render": function (data) {
                            return `<button class="btn btn-primary btn-sm" onclick="VerDetalle(${data})">
                                        <i class="bi bi-eye"></i> Detalle
                                    </button>`;
                        }
                    }
                ],
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                "order": [[0, "desc"]]
            });
        }

        function VerDetalle(id) {
            $("#txtIdVenta").text(id);

            // Llamada al controlador para obtener el detalle
            $.get("@Url.Action("ObtenerDetalle", "Libreria")", { id: id }, function (res) {

                if (res.codMensaje === "1") {
                    // 1. Armar HTML de la Cabecera
                    let cabeceraHtml = `
                        <div class="row mb-3 p-3 border rounded bg-light">
                            <div class="col-6">
                                <h6 class="text-primary fw-bold">DATOS DEL CLIENTE</h6>
                                <p class="mb-1"><strong>Razón Social:</strong> ${res.nombreCliente}</p>
                                <p class="mb-1"><strong>Documento:</strong> ${res.nroDocumentoCliente}</p>
                                <p class="mb-0"><strong>Dirección:</strong> ${res.direccionCliente || '-'}</p>
                            </div>
                            <div class="col-6 text-end">
                                <h6 class="text-primary fw-bold">DATOS DEL DOCUMENTO</h6>
                                <p class="mb-1"><strong>Tipo:</strong> ${res.tipoDocumento}</p>
                                <p class="mb-1"><strong>Moneda:</strong> ${res.tipoMoneda}</p>
                                <p class="mb-0"><strong>Total:</strong> <span class="fs-5 fw-bold">${res.importeTotal.toFixed(2)}</span></p>
                            </div>
                        </div>`;

                    // 2. Armar Tabla de Detalles
                    let detalleHtml = `<table class="table table-striped table-bordered align-middle">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>SKU</th>
                                <th>Producto</th>
                                <th>Cant.</th>
                                <th>P. Unit.</th>
                                <th>Desc.</th>
                                <th>SubTotal</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    if(res.detalle && res.detalle.length > 0){
                        res.detalle.forEach(d => {
                            // Aquí usamos d.subTotal (con s minúscula por el JSON de C#)
                            detalleHtml += `<tr>
                                <td class="text-center small">${d.sku}</td>
                                <td>${d.descripcion}</td>
                                <td class="text-center">${d.cantidad}</td>
                                <td class="text-end">${d.precioUnitario.toFixed(2)}</td>
                                <td class="text-end text-danger">${d.descuento > 0 ? '-' + d.descuento.toFixed(2) : '0.00'}</td>
                                <td class="text-end fw-bold">${d.subTotal.toFixed(2)}</td>
                            </tr>`;
                        });
                    } else {
                        detalleHtml += `<tr><td colspan="6" class="text-center">No hay detalles registrados.</td></tr>`;
                    }

                    detalleHtml += `</tbody></table>`;

                    // 3. Pintar en el modal y mostrar
                    $("#cuerpoDetalle").html(cabeceraHtml + detalleHtml);
                    $("#modalDetalleVenta").modal("show");

                } else {
                    Swal.fire('Error', res.mensaje || 'No se pudo cargar la información.', 'error');
                }
            }).fail(function() {
                Swal.fire('Error', 'Error de conexión con el servidor.', 'error');
            });
        }

        function ExportarPDF() {
            // Seleccionamos el área del modal que queremos imprimir
            const element = document.getElementById('areaImpresion');

            const opt = {
                margin:       0.5,
                filename:     `Comprobante_${$("#txtIdVenta").text()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Generar y guardar
            html2pdf().set(opt).from(element).save();
        }
    </script>
}