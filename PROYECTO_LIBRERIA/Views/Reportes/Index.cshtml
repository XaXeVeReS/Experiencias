@model PROYECTO_LIBRERIA.Models.ReporteFiltro
@{
    ViewData["Title"] = "Dashboard de Ventas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
    .card-header-primary {
        background: linear-gradient(45deg, #0d6efd, #0a58ca);
        color: white;
    }

    .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
        color: #0c63e4;
        box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
    }
    /* Animación de entrada */
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }</style>

<div class="container-fluid fade-in">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
        <h2 class="text-primary fw-bold"><i class="bi bi-speedometer2"></i> Dashboard de Gestión</h2>
        <span class="badge bg-secondary p-2"><i class="bi bi-clock"></i> @DateTime.Now.ToShortDateString()</span>
    </div>

    <div class="accordion shadow-sm mb-4" id="accordionFiltros">
        <div class="accordion-item border-0">
            <h2 class="accordion-header" id="headingFilters">
                <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilters" aria-expanded="true">
                    <i class="bi bi-funnel-fill me-2"></i> Configuración de Reporte
                </button>
            </h2>
            <div id="collapseFilters" class="accordion-collapse collapse show" data-bs-parent="#accordionFiltros">
                <div class="accordion-body bg-light">
                    <form id="frmReporte">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label text-muted small fw-bold">SECCIÓN</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-folder2-open text-primary"></i></span>
                                    <select id="selSeccion" class="form-select fw-bold" onchange="filtrarModos()">
                                        <option value="">Seleccione Sección...</option>
                                        <option value="Analisis">Análisis de Ventas</option>
                                        <option value="Temporalidad">Temporalidad</option>
                                        <option value="Rankings">Rankings y KPIs</option>
                                        <option value="Finanzas">Finanzas e Ingresos</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label text-muted small fw-bold">TIPO DE REPORTE</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="bi bi-list-task text-primary"></i></span>
                                    <select id="selModo" name="Modo" class="form-select fw-bold" disabled>
                                        <option value="">Primero elija sección...</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label text-muted small fw-bold">RANGO DE FECHAS</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white">Del</span>
                                    <input asp-for="FechaInicio" type="date" class="form-control" />
                                    <span class="input-group-text bg-white">Al</span>
                                    <input asp-for="FechaFin" type="date" class="form-control" />
                                </div>
                            </div>

                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                                    <i class="bi bi-eraser"></i> Limpiar
                                </button>
                            </div>

                            <hr class="text-muted my-3">

                            <div class="col-md-3">
                                <label class="form-label text-muted small">Vendedor</label>
                                <select id="selUsuario" name="IdUsuario" class="form-select select2-ajax"
                                        data-url="@Url.Action("BuscarUsuarios")" data-placeholder="Todos"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">Cliente</label>
                                <select id="selCliente" name="IdCliente" class="form-select select2-ajax"
                                        data-url="@Url.Action("BuscarClientes")" data-placeholder="Todos"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">Categoría</label>
                                <select id="selCategoria" name="IdCategoria" class="form-select select2-ajax"
                                        data-url="@Url.Action("BuscarCategorias")" data-placeholder="Todas"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-muted small">Producto</label>
                                <select id="selProducto" name="SKU" class="form-select select2-ajax"
                                        data-url="@Url.Action("BuscarProductos")" data-placeholder="Todos"></select>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12 d-flex flex-wrap gap-2 justify-content-between">
                                <button type="button" class="btn btn-primary btn-lg shadow px-4 btn-action" onclick="generar()">
                                    <i class="bi bi-search"></i> Generar Reporte
                                </button>

                                <div class="btn-group shadow-sm">
                                    <button type="button" class="btn btn-success btn-action" onclick="exportExcel()">
                                        <i class="bi bi-file-earmark-excel"></i> Excel
                                    </button>
                                    <button type="button" class="btn btn-danger btn-action" onclick="exportPDF()">
                                        <i class="bi bi-file-earmark-pdf"></i> PDF
                                    </button>
                                </div>

                                <div class="btn-group shadow-sm">
                                    <button type="button" class="btn btn-outline-dark btn-action" onclick="verGrafico('bar')">
                                        <i class="bi bi-bar-chart-fill"></i> Barras
                                    </button>
                                    <button type="button" class="btn btn-outline-dark btn-action" onclick="verGrafico('line')">
                                        <i class="bi bi-graph-up"></i> Líneas
                                    </button>
                                    <button type="button" class="btn btn-outline-dark btn-action" onclick="verGrafico('pie')">
                                        <i class="bi bi-pie-chart-fill"></i> Circular
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 mb-5">
        <div class="card-header card-header-primary d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-table"></i> Resultados</h5>
            <span id="badgeCount" class="badge bg-light text-dark">0 registros</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="tbl" class="table table-striped table-hover align-middle w-100">
                    <thead class="table-light">
                    </thead>
                    <tbody>
                        <tr><td class="text-center p-5 text-muted">Seleccione filtros y presione "Generar Reporte"</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalGrafico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="bi bi-graph-up-arrow text-primary"></i> Análisis Visual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div style="height: 500px; width: 100%;">
                    <canvas id="canvasGrafico"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
            const filtrarModos = () => {
            const seccion = document.getElementById('selSeccion').value;
            const selModo = document.getElementById('selModo');

            // Limpiar opciones actuales
            selModo.innerHTML = '';

            const opciones = {
                "Analisis": [
                    { v: "VENTAS_VENDEDOR", t: "Ventas por Vendedor" },
                    { v: "VENTAS_CLIENTE", t: "Ventas por Cliente" },
                    { v: "VENTAS_PRODUCTO", t: "Ventas por Producto" },
                    { v: "VENTAS_CATEGORIA", t: "Ventas por Categoría" },
                    { v: "VENTAS_MEDIO_PAGO", t: "Ventas por Medio de Pago" }
                ],
                "Temporalidad": [
                    { v: "VENTAS_POR_DIA", t: "Ventas Diarias" },
                    { v: "VENTAS_POR_MES", t: "Ventas Mensuales" },
                    { v: "VENTAS_POR_ANO", t: "Ventas Anuales" },
                    { v: "VENTAS_COMPARATIVO_MES", t: "Comparativo Mes a Mes" },
                    { v: "CLIENTES_HISTORIAL", t: "Historial Detallado de Clientes" }
                ],
                "Rankings": [
                    { v: "PRODUCTOS_TOP", t: "Top 20 Productos Más Vendidos" },
                    { v: "PRODUCTOS_LOW", t: "Productos con Menos Ventas" },
                    { v: "PRODUCTOS_TOP_CATEGORIA", t: "Top 5 Productos por Categoría" },
                    { v: "PRODUCTOS_SIN_MOVIMIENTO", t: "Productos sin Movimiento (Alerta)" },
                    { v: "VENDEDORES_TOP", t: "Top 10 Mejores Vendedores" },
                    { v: "VENDEDORES_LOW", t: "Vendedores con Bajo Rendimiento" },
                    { v: "CLIENTES_TOP", t: "Top 20 Mejores Clientes" },
                    { v: "CLIENTES_LOW", t: "Clientes con Menos Compras" },
                    { v: "CLIENTES_INACTIVOS", t: "Lista de Clientes Inactivos" },
                    { v: "PAGO_TOP", t: "Medios de Pago más Utilizados" }
                ],
                "Finanzas": [
                    { v: "PAGO_RECAUDACION", t: "Recaudación por Medio de Pago" },
                    { v: "INGRESOS_DIA", t: "Ingresos Totales por Día" },
                    { v: "INGRESOS_MES", t: "Ingresos Totales por Mes" },
                    { v: "INGRESOS_ANO", t: "Ingresos Totales por Año" }
                ]
            };

            if (seccion && opciones[seccion]) {
                selModo.disabled = false;
                opciones[seccion].forEach(opt => {
                    const el = document.createElement('option');
                    el.value = opt.v;
                    el.textContent = opt.t;
                    selModo.appendChild(el);
                });
            } else {
                selModo.disabled = true;
                const el = document.createElement('option');
                el.textContent = "Primero elija sección...";
                selModo.appendChild(el);
            }
        };
        // Uso de variables const/let y Arrow Functions
        let chartInstance = null;

        // Reemplazo de $(document).ready()
        document.addEventListener('DOMContentLoaded', () => {
            initSelect2();
            setupEventListeners();
        });

        const setupEventListeners = () => {
            const selCategoria = document.getElementById('selCategoria');
            if (selCategoria) {
                selCategoria.addEventListener('change', () => {
                    // Select2 todavía requiere el trigger de jQuery para reaccionar
                    const $selProducto = $('#selProducto');
                    $selProducto.val(null).trigger('change');
                });
            }
        };

        // --- 1. CONFIGURACIÓN SELECT2 (Sintaxis moderna de búsqueda) ---
        const initSelect2 = () => {
            document.querySelectorAll('.select2-ajax').forEach(el => {
                const $el = $(el); // Mantenemos el wrapper solo para el plugin
                $el.select2({
                    theme: 'bootstrap-5',
                    placeholder: el.dataset.placeholder || 'Seleccionar...',
                    allowClear: true,
                    width: '100%',
                    ajax: {
                        url: el.dataset.url,
                        type: "GET",
                        dataType: 'json',
                        delay: 250,
                        data: params => ({
                            filtro: params.term || "",
                            idCategoria: document.getElementById('selCategoria')?.value
                        }),
                        processResults: data => ({ results: data })
                    }
                });
            });
        };

        // --- 2. LIMPIAR FILTROS ---
        const limpiarFiltros = () => {
            const form = document.getElementById("frmReporte");
            form.reset();

            // Reset de Select2 (requiere jQuery por el plugin)
            $('.select2-ajax').val(null).trigger('change');

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'info',
                title: 'Filtros reiniciados',
                showConfirmButton: false,
                timer: 1500
            });
        };

        // --- 3. UI LOADING (Refactorizado) ---
        const toggleLoading = (isLoading) => {
            const btns = document.querySelectorAll('.btn-action');
            btns.forEach(btn => btn.disabled = isLoading);

            if (isLoading) {
                Swal.fire({
                    title: 'Procesando...',
                    html: 'Generando datos, por favor espere.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
            } else {
                Swal.close();
            }
        };

        // --- 4. GENERAR REPORTE (Usando Async/Await) ---
        const generar = async () => {
            toggleLoading(true);
            const form = document.getElementById("frmReporte");
            const data = new FormData(form);

            try {
                const response = await fetch("/Reportes/Generar", {
                    method: "POST",
                    body: data
                });

                if (!response.ok) throw new Error("Error del servidor");

                const lista = await response.json();
                renderTable(lista);

                document.getElementById('badgeCount').textContent = `${lista.length} registros`;

                if (lista.length > 0) {
                    if (window.innerWidth < 768) {
                        // Colapso nativo de Bootstrap 5
                        const filterEl = document.getElementById('collapseFilters');
                        const bsCollapse = bootstrap.Collapse.getInstance(filterEl) || new bootstrap.Collapse(filterEl);
                        bsCollapse.hide();
                    }
                } else {
                    Swal.fire('Sin resultados', 'Intente cambiar los filtros.', 'info');
                }
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            } finally {
                toggleLoading(false);
            }
        };

        const renderTable = (lista) => {
            // Destrucción de DataTable (plugin basado en jQuery)
            if ($.fn.DataTable.isDataTable('#tbl')) {
                $('#tbl').DataTable().destroy();
            }

            const tbl = document.getElementById("tbl");
            if (!lista?.length) {
                tbl.innerHTML = "<tbody><tr><td class='text-center p-4 text-muted'>No se encontraron datos.</td></tr></tbody>";
                return;
            }

            const keys = Object.keys(lista[0]);

            // Construcción moderna con Template Literals y Map
            const head = `<thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead>`;
            const rows = lista.map(row => `
                <tr>${keys.map(k => `<td>${formatValue(row[k], k)}</td>`).join('')}</tr>
            `).join('');

            tbl.innerHTML = `${head}<tbody>${rows}</tbody>`;

            // Reinicializar DataTable
            $('#tbl').DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
                responsive: true,
                pageLength: 10,
                order: [],
                //dom: '<"d-flex justify-content-between mb-2"f>rt<"d-flex justify-content-between mt-2"ip>'
            });
        };

        // --- 5. FORMATO INTELIGENTE ---
        const formatValue = (val, key) => {
            if (val == null) return "";

            const isCurrency = /precio|total|venta|monto|ingreso/i.test(key);
            if (typeof val === 'number' && isCurrency) {
                return new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(val);
            }

            if (typeof val === 'string' && val.includes('T') && !isNaN(Date.parse(val))) {
                return new Date(val).toLocaleDateString('es-PE');
            }
            return val;
        };

        // --- 6. EXPORTACIONES (Async/Await) ---
        const exportar = async (url, tipo) => {
            Swal.fire({ title: `Exportando ${tipo}...`, didOpen: () => Swal.showLoading() });
            const data = new FormData(document.getElementById("frmReporte"));

            try {
                const response = await fetch(url, { method: "POST", body: data });
                const blob = await response.blob();

                Swal.close();
                if (blob.size < 100) {
                    Swal.fire('Error', 'Archivo vacío', 'warning');
                    return;
                }

                const urlBlob = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = urlBlob;
                a.download = `reporte_${new Date().getTime()}.${tipo === 'Excel' ? 'xlsx' : 'pdf'}`;
                a.click();
                URL.revokeObjectURL(urlBlob);

                Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 })
                    .fire({ icon: 'success', title: `Archivo ${tipo} listo` });
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        };

        const exportExcel = () => exportar("/Reportes/ExportExcel", "Excel");
        const exportPDF = () => exportar("/Reportes/ExportPDF", "PDF");

        // --- 7. GRÁFICOS ---
        const verGrafico = async (tipo) => {
            Swal.fire({ title: 'Preparando gráfico...', didOpen: () => Swal.showLoading() });
            const data = new FormData(document.getElementById("frmReporte"));

            try {
                const response = await fetch("/Reportes/Generar", { method: "POST", body: data });
                const lista = await response.json();

                Swal.close();
                if (!lista?.length) {
                    Swal.fire('Info', 'Sin datos para graficar', 'info');
                    return;
                }

                const modalEl = document.getElementById('modalGrafico');
                const myModal = new bootstrap.Modal(modalEl);
                myModal.show();

                // Esperar a que el modal sea visible para dibujar el canvas
                modalEl.addEventListener('shown.bs.modal', () => drawChart(lista, tipo), { once: true });
            } catch (err) {
                Swal.fire('Error', 'No se pudieron obtener los datos para el gráfico.', 'error');
            }
        };

        const drawChart = (lista, tipo) => {
            const keys = Object.keys(lista[0]);
            const labelKey = keys[0];
            const valueKey = keys[keys.length - 1];

            const ctx = document.getElementById("canvasGrafico");
            if (chartInstance) chartInstance.destroy();

            const palette = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'];

            chartInstance = new Chart(ctx, {
                type: tipo,
                data: {
                    labels: lista.map(x => x[labelKey]),
                    datasets: [{
                        label: valueKey,
                        data: lista.map(x => x[valueKey]),
                        backgroundColor: (tipo === 'pie' || tipo === 'doughnut') ? palette : '#4e73df',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: `Análisis por ${valueKey}` }
                    }
                }
            });
        };
    </script>
}