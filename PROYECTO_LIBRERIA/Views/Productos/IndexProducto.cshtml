@{
    ViewData["Title"] = "Productos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="card mt-3">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span><i class="bi bi-box-seam"></i> Productos</span>
        <button class="btn btn-success btn-sm" onclick="abrirModalNuevo()">
            <i class="bi bi-plus-circle"></i> Nuevo producto
        </button>
    </div>
    <div class="card-body">
        <table id="tblProductos" class="table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th>SKU</th>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>IGV (18%)</th>
                    <th>Precio Venta</th>
                    <th>Estado</th>
                    <th style="width: 90px;">Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalProductoLabel">Nuevo producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">

                <div class="mb-3">
                    <label for="txtSku" class="form-label">SKU</label>
                    <input type="text" id="txtSku" class="form-control" onkeyup="soloNumeros(this)" oninput="soloNumeros(this)" maxlength="20" />
                    <small class="text-muted">Código único del producto.</small>
                </div>

                <div class="mb-3">
                    <label for="txtNombreProd" class="form-label">Nombre</label>
                    <input type="text" id="txtNombreProd" maxlength="150" class="form-control" />
                </div>

                <div class="mb-3">
                    <label for="txtDescripcionProd" class="form-label">Descripción</label>
                    <textarea id="txtDescripcionProd" class="form-control" maxlength="250" rows="2"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cboCategoria" class="form-label">Categoría</label>
                        <select id="cboCategoria" class="form-select">
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cboProveedor" class="form-label">Proveedor</label>
                        <select id="cboProveedor" class="form-select">
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="txtPrecio" class="form-label">Precio Final</label>
                        <input type="number" step="0.01" id="txtPrecio" class="form-control" oninput="calcularDesglose()" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label text-muted">Sin IGV</label>
                        <input type="text" id="txtPrecioSinIGV" class="form-control bg-light" readonly />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label text-muted">Monto IGV</label>
                        <input type="text" id="txtMontoIGV" class="form-control bg-light" readonly />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="txtStockMin" class="form-label">Stock mínimo</label>
                        <input type="number" step="0.001" id="txtStockMin" maxlength="14" class="form-control" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cboEstado" class="form-label">Estado</label>
                        <select id="cboEstado" class="form-select">
                            <option value="">-- Seleccione --</option>
                            <option value="ACTIVO">ACTIVO</option>
                            <option value="INACTIVO">INACTIVO</option>
                        </select>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarProducto()">
                    <i class="bi bi-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let tablaProductos;
        let modalProducto;

        $(document).ready(function () {
            const modalElement = document.getElementById('modalProducto');
            modalProducto = new bootstrap.Modal(modalElement);

            cargarTablaProductos();
            cargarCategoriasCombo();
            cargarProveedoresCombo();
        });

        function cargarTablaProductos() {
            tablaProductos = $('#tblProductos').DataTable({
                ajax: {
                    url: '@Url.Action("ProductosLista_Controller", "Productos")',
                    type: 'GET',
                    datatype: 'json'
                },
                columns: [
                    { data: "sku" },
                    { data: "nombre" },
                    { data: "nombreCategoria" },
                    {
                        data: "precioSinIGV",
                        render: function(data) { return data ? "S/ " + parseFloat(data).toFixed(2) : "0.00"; }
                    },
                    {
                        data: "igv",
                        render: function(data) { return data ? "S/ " + parseFloat(data).toFixed(2) : "0.00"; }
                    },
                    {
                        data: "precio",
                        render: function(data) { return "<strong>S/ " + parseFloat(data).toFixed(2) + "</strong>"; }
                    },
                    { data: "estado" },
                    {
                        data: "sku",
                        render: function (data) {
                            return `<button class="btn btn-sm btn-primary me-1" onclick="editarProducto('${data}')">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>`;
                        }
                    }
                ],
                pageLength: 5,
                language: {
                    url: "https://cdn.datatables.net/plug-ins/2.1.5/i18n/es-MX.json"
                }
            });
        }

        function calcularDesglose() {
            let total = parseFloat($('#txtPrecio').val()) || 0;
            let sinIgv = total / 1.18;
            let igv = total - sinIgv;

            $('#txtPrecioSinIGV').val(sinIgv.toFixed(2));
            $('#txtMontoIGV').val(igv.toFixed(2));
        }

        function cargarCategoriasCombo() {
            $.ajax({
                url: '@Url.Action("CategoriasLista_Controller", "Productos")',
                type: 'GET',
                success: function (res) {
                    const data = res.data || res;
                    const $cbo = $('#cboCategoria');
                    $cbo.empty();
                    $cbo.append('<option value="">-- Seleccione --</option>');
                    data.forEach(function (item) {
                        $cbo.append(`<option value="${item.idCategoria}">${item.nombre}</option>`);
                    });
                }
            });
        }

        function cargarProveedoresCombo() {

            $.ajax({
                url: '@Url.Action("ProveedoresListaSimple_Controller", "Proveedores")',
                type: 'GET',
                success: function (res) {
                    const data = res.data || res;
                    const $cbo = $('#cboProveedor');
                    $cbo.empty();
                    $cbo.append('<option value="">-- Seleccione --</option>');
                    data.forEach(function (item) {
                        $cbo.append(`<option value="${item.entidadId}">${item.nombreRazon}</option>`);
                    });
                }
            });
        }

        function abrirModalNuevo() {
            $('#txtSku').prop('disabled', false);
            $('#txtSku').val('');
            $('#txtNombreProd').val('');
            $('#txtDescripcionProd').val('');
            $('#cboCategoria').val('');
            $('#cboProveedor').val('');
            $('#txtPrecio').val('');
            $('#txtPrecioSinIGV').val('');
            $('#txtMontoIGV').val('');
            $('#txtStockMin').val('');
            $('#cboEstado').val('');

            $('#modalProductoLabel').text('Nuevo producto');
            modalProducto.show();
        }

        function editarProducto(sku) {
            $.ajax({
                url: '@Url.Action("ProductosObtener_Controller", "Productos")',
                type: 'GET',
                data: { sku: sku },
                success: function (data) {
                    $('#txtSku').val(data.sku).prop('disabled', true);
                    $('#txtNombreProd').val(data.nombre);
                    $('#cboProveedor').val(data.entidadIdProveedor || '');
                    $('#txtDescripcionProd').val(data.descripcion);
                    $('#cboCategoria').val(data.idCategoria || '');
                    $('#txtPrecio').val(data.precio);

                    // Calculamos el desglose visualmente al cargar
                    calcularDesglose();

                    $('#txtStockMin').val(data.stockMin);
                    $('#cboEstado').val(data.estado || '');

                    $('#modalProductoLabel').text('Editar producto');
                    modalProducto.show();
                }
            });
        }

        function guardarProducto() {
            const sku = $('#txtSku').val();
            const precio = $('#txtPrecio').val();

            if (!sku || !$('#txtNombreProd').val() || !precio) {
                Swal.fire('Validación', 'Completar los campos obligatorios.', 'warning');
                return;
            }

            const modelo = {
                sku: sku,
                nombre: $('#txtNombreProd').val(),
                entidadIdProveedor: $('#cboProveedor').val() ? parseInt($('#cboProveedor').val()) : null,
                descripcion: $('#txtDescripcionProd').val(),
                idCategoria: $('#cboCategoria').val() ? parseInt($('#cboCategoria').val()) : null,
                precio: parseFloat(precio),
                stockMin: $('#txtStockMin').val() ? parseFloat($('#txtStockMin').val()) : null,
                estado: $('#cboEstado').val()
            };

            const esEdicion = $('#txtSku').prop('disabled');
            const url = esEdicion
                ? '@Url.Action("ProductosActualizar_Controller", "Productos")'
                : '@Url.Action("ProductosCrear_Controller", "Productos")';

            $.ajax({
                url: url,
                type: "POST",
                data: JSON.stringify(modelo),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.codMensaje == "1") {
                        Swal.fire('Correcto', data.mensaje, 'success');
                        modalProducto.hide();
                        tablaProductos.ajax.reload();
                    } else {
                        Swal.fire('Advertencia', data.mensaje, 'warning');
                    }
                }
            });
        }

        function soloNumeros(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }
    </script>
}