@{
    ViewData["Title"] = "Inventario / Kardex";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-3">
    <h3 class="mb-3"><i class="bi bi-box-seam"></i> Inventario (IN) y Kardex</h3>

    <ul class="nav nav-tabs" id="invTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-inv-tab" data-bs-toggle="tab" data-bs-target="#tab-inv" type="button" role="tab">
                Entrada Stock (IN)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-kdx-tab" data-bs-toggle="tab" data-bs-target="#tab-kdx" type="button" role="tab">
                Kardex
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3 bg-white">
        <!-- ===================== ENTRADA (IN) ===================== -->
        <div class="tab-pane fade show active" id="tab-inv" role="tabpanel">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Producto</label>
                    <select id="cboProdEntrada" class="form-select"></select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cantidad</label>
                    <input id="txtCantidad" type="number" step="0.001" min="0" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Costo Unit.</label>
                    <input id="txtCosto" type="number" step="0.0001" min="0" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Origen</label>
                    <select id="cboOrigen" class="form-select">
                        <option value="AJUSTE">AJUSTE</option>
                        <option value="COMPRA">COMPRA</option>
                    </select>
                </div>
                <div class="col-md-1 d-grid">
                    <button id="btnAgregar" class="btn btn-primary"><i class="bi bi-plus-lg"></i></button>
                </div>
            </div>

            <hr />

            <div class="table-responsive">
                <table class="table table-sm table-bordered" id="tblEntrada">
                    <thead class="table-dark">
                        <tr>
                            <th>SKU</th>
                            <th>Producto</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Costo</th>
                            <th style="width:60px;">Quitar</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button id="btnRegistrar" class="btn btn-success">
                    <i class="bi bi-check2-circle"></i> Registrar Entrada
                </button>
            </div>
        </div>

        <!-- ===================== KARDEX ===================== -->
        <div class="tab-pane fade" id="tab-kdx" role="tabpanel">
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Producto</label>
                    <select id="cboProdKardex" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Stock actual</label>
                    <input id="txtStockActual" class="form-control" disabled />
                </div>
                <div class="col-md-3 d-grid">
                    <button id="btnBuscarKardex" class="btn btn-dark">
                        <i class="bi bi-search"></i> Ver Kardex
                    </button>
                </div>
            </div>

            <hr />

            <div class="table-responsive">
                <table class="display" style="width:100%" id="tblKardex">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Costo</th>
                            <th>Origen</th>
                            <th>RefTabla</th>
                            <th>RefId</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let productosCache = [];
    let detalleEntrada = [];
    let dtKardex = null;

    $(document).ready(function () {
        cargarProductos();

        $('#btnAgregar').on('click', function () { agregarItem(); });
        $('#btnRegistrar').on('click', function () { registrarEntrada(); });
        $('#btnBuscarKardex').on('click', function () { cargarKardex(); });
    });

    function cargarProductos() {
        $.ajax({
            url: '@Url.Action("ProductosLista_Controller", "Productos")',
            type: 'GET',
            success: function (res) {
                productosCache = res.data || [];

                llenarCombo('#cboProdEntrada', productosCache);
                llenarCombo('#cboProdKardex', productosCache);
            },
            error: function () {
                Swal.fire('Error', 'No se pudo cargar la lista de productos.', 'error');
            }
        });
    }

    function llenarCombo(selector, lista) {
        const $cbo = $(selector);
        $cbo.empty();
        $cbo.append('<option value="">-- Seleccione --</option>');

        lista.forEach(p => {
            const txt = `${p.sku} - ${p.nombre}`;
            $cbo.append(`<option value="${p.sku}">${txt}</option>`);
        });
    }

    function agregarItem() {
        const sku = $('#cboProdEntrada').val();
        const cant = parseFloat($('#txtCantidad').val());
        const costoTxt = $('#txtCosto').val();
        const costo = costoTxt ? parseFloat(costoTxt) : null;

        if (!sku) { Swal.fire('Atención', 'Seleccione un producto.', 'warning'); return; }
        if (!cant || cant <= 0) { Swal.fire('Atención', 'Cantidad debe ser mayor a 0.', 'warning'); return; }

        const prod = productosCache.find(x => x.sku === sku);
        const nombre = prod ? prod.nombre : '';

        // Si ya existe el SKU en el detalle, sumamos cantidad
        const idx = detalleEntrada.findIndex(x => x.sku === sku);
        if (idx >= 0) {
            detalleEntrada[idx].cantidad = parseFloat((detalleEntrada[idx].cantidad + cant).toFixed(3));
            if (costo !== null) detalleEntrada[idx].costoUnit = costo;
        } else {
            detalleEntrada.push({ sku: sku, nombre: nombre, cantidad: cant, costoUnit: costo });
        }

        $('#txtCantidad').val('');
        $('#txtCosto').val('');
        renderDetalle();
    }

    function renderDetalle() {
        const $tb = $('#tblEntrada tbody');
        $tb.empty();

        detalleEntrada.forEach((x, i) => {
            $tb.append(`
                <tr>
                    <td>${x.sku}</td>
                    <td>${x.nombre ?? ''}</td>
                    <td class="text-end">${x.cantidad}</td>
                    <td class="text-end">${x.costoUnit ?? ''}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-danger" onclick="quitarItem(${i})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    function quitarItem(i) {
        detalleEntrada.splice(i, 1);
        renderDetalle();
    }

    function registrarEntrada() {
        if (detalleEntrada.length === 0) {
            Swal.fire('Atención', 'Agrega al menos 1 item.', 'warning');
            return;
        }

        const payload = {
            origen: $('#cboOrigen').val(),
            detalle: detalleEntrada
        };

        $.ajax({
            url: '@Url.Action("InventarioEntradaGrupo_Controller", "Productos")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                if (res.codMensaje === "1") {
                    Swal.fire('OK', res.mensaje, 'success');
                    detalleEntrada = [];
                    renderDetalle();
                } else {
                    Swal.fire('Error', res.mensaje || 'No se pudo registrar.', 'error');
                }
            },
            error: function (xhr) {
                Swal.fire('Error', xhr.responseText || 'Error en servidor.', 'error');
            }
        });
    }

    function cargarKardex() {
        const sku = $('#cboProdKardex').val();
        if (!sku) { Swal.fire('Atención', 'Seleccione un producto.', 'warning'); return; }

        // Stock actual
        $.get('@Url.Action("StockDisponible_Controller", "Productos")', { sku: sku }, function (res) {
            $('#txtStockActual').val(res.stock);
        });

        // DataTable Kardex
        if (dtKardex) {
            dtKardex.destroy();
            $('#tblKardex').empty().append(`
                <thead>
                    <tr>
                        <th>Fecha</th><th>Tipo</th><th>Cantidad</th><th>Costo</th><th>Origen</th><th>RefTabla</th><th>RefId</th><th>Saldo</th>
                    </tr>
                </thead>
            `);
        }

        dtKardex = $('#tblKardex').DataTable({
            ajax: {
                url: '@Url.Action("KardexPorSku_Controller", "Productos")',
                data: { sku: sku },
                dataSrc: 'data'
            },
            order: [[0, 'desc']],
            columns: [
                { data: 'fecha' },
                { data: 'tipo' },
                { data: 'cantidad' },
                { data: 'costoUnit' },
                { data: 'origen' },
                { data: 'refTabla' },
                { data: 'refId' },
                { data: 'saldo' }
            ]
        });
    }
</script>
